function initApp(){firebase.auth().onAuthStateChanged(function(e){if(e){userId=firebase.auth().currentUser.uid;var t=firebase.database().ref("/users/"+userId);t.child("history").on("value",function(e){if(e.exists()){var t=[];for(var o in e.val())if(e.val().hasOwnProperty(o)){var a=e.val()[o];t.push({url:a.url,changes:a.changes,changes_percentage:a.changes_percentage,date:a.date})}printHistory(t)}else noData(!1),console.log("no history")}),t.on("value",function(e){null!=e.val()?chosenColor(e.val().highlight_color):console.log("new user")}),t.child("followed_links").on("value",function(e){if(null!=e.val()){var t=[];for(var o in e.val())if(e.val().hasOwnProperty(o)){var a=e.val()[o];t.push(a.url)}printLinks(t)}else noData(!0),console.log("no links")})}else startAuth(!0)})}function chosenColor(e){document.getElementById("hi-color").setAttribute("value",e)}function printLinks(e){$(".followed table").empty(),$(".followed .loading").remove(),$(".followed .no-data").remove();for(var t=0;t<e.length;t++)element=e[t],$("<tr></tr>").appendTo(".followed table"),$(".followed table tr:last-of-type").append($("<td></td>").text(t+1),$("<td></td>").text(e[t]),$('<td class=" remove" onclick="deleteLink(\''+e[t]+'\')"><span class="glyphicon glyphicon-remove"></span><span class="hidden-xs">Remove</span></td>'))}function printHistory(e){var t=$(".history table");t.empty(),$(".history .loading").remove(),$(".history .no-data").remove(),$("<tr><th>No.</th><th>URL</th><th>Changes</th><th>% Changed</th><th>Date</th></tr>").appendTo(t);for(var o=0;o<e.length;o++){var a=e[o];$("<tr></tr>").appendTo(t),$(".history table tr:last-of-type").append($("<td></td>").text(o+1),$("<td></td>").text(a.url),$("<td></td>").text(a.changes),$("<td></td>").text(a.changes_percentage+"%"),$("<td></td>").text(a.date))}}function deleteLink(e){$(".followed table").empty();var t=firebase.auth().currentUser.uid,o=firebase.database().ref("/users/"+t+"/followed_links");o.orderByChild("url").equalTo(e).once("value",function(e){if(e.exists()){console.log("will delete");var t=Object.keys(e.val())[0];o.child(t).child("url").set(null)}})}function downloadObjectAsJson(e,t){var o="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),a=document.createElement("a");a.setAttribute("href",o),a.setAttribute("download",t+".json"),a.click(),a.remove()}function updateConfiguration(e){if(0!=Object.keys(e).length){var t=firebase.auth().currentUser.uid,o=firebase.database().ref("/users/"),a={};a[t]=e,o.update(a)}}function noData(e){e?($(".followed .loading").remove(),$('<p class="no-data">No followed links</p>').insertBefore(".followed .btn")):($(".history .loading").remove(),$('<p class="no-data">No history</p>').appendTo(".history"))}function startAuth(e){var t=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithRedirect(t),firebase.auth().getRedirectResult().then(function(e){e.user;console.log(e)}).catch(function(e){console.log(e)})}function logout(){firebase.auth().signOut().then(function(){console.log("signed-out")}).catch(function(e){console.log("signed-out error"),console.log(e)})}var config={authDomain:"cliw-test.firebaseapp.com",apiKey:"AIzaSyDNynAgYGkrXFQfoPrY2iScW8aT28yQmYk",databaseURL:"https://cliw-test.firebaseio.com",storageBucket:"gs://cliw-test.appspot.com/"};firebase.initializeApp(config),document.addEventListener("DOMContentLoaded",function(e){document.querySelector("#hi-color").addEventListener("change",function(e){e.target.id;var t=e.target.value,o=firebase.auth().currentUser.uid,a=firebase.database().ref("/users/"+o);a.once("value",function(e){if(e.exists()){var o={};o["/highlight_color"]=t,a.update(o)}else console.log("Tried to change default color and failed")})}),document.querySelector("#addPageModal .btn-success").addEventListener("click",function(e){var t=document.querySelector("#addPageModal #url").value,o=new RegExp(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/gi);if(t.match(o)){var a=firebase.auth().currentUser.uid,n=firebase.database().ref("/users/"+a+"/followed_links"),r=n.push().key;n.child(r).set({url:t})}else alert("Invalid url");document.querySelector("#addPageModal #url").value=""}),document.querySelector("#options .download").addEventListener("click",function(e){var t=firebase.auth().currentUser.uid;firebase.database().ref("/users/"+t).once("value",function(e){e.exists()&&downloadObjectAsJson(e.val(),"settings")}),document.querySelector("#addPageModal #url").value=""}),document.getElementById("import").addEventListener("click",function(e){var t=document.getElementById("selectFiles").files;if(t.length<=0)return!1;var o=new FileReader;o.onload=function(e){console.log(e);updateConfiguration(JSON.parse(e.target.result))},o.readAsText(t.item(0))})}),window.onload=function(){initApp()};